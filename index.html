<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPoker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --stake-dark: #0f212e; --stake-card: #1a2c38; --stake-green: #00e701; --card-width: 65px; --card-height: 90px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--stake-dark); color: white; overflow-x: hidden; user-select: none; }
        
        @media (min-width: 768px) { :root { --card-width: 90px; --card-height: 126px; } }

        .playing-card {
            width: var(--card-width); height: var(--card-height); background: white; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: space-between;
            padding: 6px; position: relative; font-weight: bold; font-size: 1.1rem; transition: transform 0.2s;
        }
        .suit-red { color: #e91e63; } .suit-black { color: #2d3436; }
        .card-back { background: linear-gradient(135deg, #1a2c38 25%, #2c3e50 100%); border: 2px solid #fff; }
        .card-center-suit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.2rem; opacity: 0.15; }
        
        .active-turn { border: 3px solid #00e701; box-shadow: 0 0 15px rgba(0,231,1,0.3); transform: scale(1.05); }
        .opponent-seat { background: #1a2c38; border: 1px solid #2f4553; border-radius: 12px; transition: all 0.3s; min-width: 110px; }
        .opponent-folded { opacity: 0.5; filter: grayscale(1); }
        
        .community-card-slot { width: var(--card-width); height: var(--card-height); border: 2px dashed #2f4553; border-radius: 8px; }
        .btn-action { transition: all 0.1s; } .btn-action:active { transform: translateY(2px); }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col bg-[#0f212e]">

    <nav class="h-16 bg-[#1a2c38] flex items-center justify-between px-6 shadow-xl z-20 shrink-0 border-b border-[#2f4553]">
        <div class="font-black text-xl tracking-tighter italic flex items-center gap-2">
             <i class="fas fa-spade text-[#00e701]"></i> STAKE<span class="text-gray-500">.POKER</span>
        </div>
        <div class="flex items-center gap-4">
             <div class="hidden md:flex flex-col items-end">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Room</span>
                <span id="roomCodeDisplay" class="text-white font-mono font-bold tracking-widest">---</span>
            </div>
            <div class="bg-[#0f212e] rounded-full px-5 py-2 flex items-center gap-3 border border-[#2f4553]">
                <span class="text-xs text-gray-400 font-bold uppercase">Balance</span>
                <span id="balanceDisplay" class="font-mono font-bold text-[#00e701] text-lg">$0</span>
            </div>
        </div>
    </nav>

    <main class="flex-1 relative flex flex-col items-center justify-between p-4 overflow-hidden w-full max-w-7xl mx-auto">
        
        <!-- Setup -->
        <div id="lobbyScreen" class="absolute inset-0 z-50 bg-[#0f212e] flex flex-col items-center justify-center p-4">
            <h1 class="text-5xl md:text-7xl font-black italic text-white mb-2 tracking-tighter">TEXAS HOLD'EM</h1>
            <div class="bg-[#1a2c38] p-8 rounded-2xl border border-[#2f4553] shadow-2xl w-full max-w-md">
                <input type="text" id="playerNameInput" placeholder="YOUR NAME" class="w-full bg-[#0f212e] text-white p-4 rounded-lg border border-[#2f4553] focus:border-[#00e701] font-bold text-center mb-4 outline-none">
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="switchTab('create')" id="tabCreate" class="pb-2 text-[#00e701] border-b-2 border-[#00e701] font-bold">Create</button>
                    <button onclick="switchTab('join')" id="tabJoin" class="pb-2 text-gray-500 hover:text-white">Join</button>
                </div>
                <div id="viewCreate">
                    <label class="text-xs text-gray-500 font-bold mb-1 block">STARTING CHIPS</label>
                    <input type="number" id="startStackInput" value="1000" class="w-full bg-[#0f212e] text-white p-3 rounded border border-[#2f4553] mb-4 font-mono">
                    <button onclick="createGame()" class="w-full bg-[#00e701] hover:bg-[#00c201] text-black font-bold py-4 rounded-lg shadow-lg uppercase tracking-wide btn-action">Create Room</button>
                </div>
                <div id="viewJoin" class="hidden">
                    <input type="text" id="roomCodeInput" placeholder="ROOM CODE" maxlength="6" class="w-full bg-[#0f212e] text-white p-3 rounded border border-[#2f4553] mb-4 font-mono text-center text-xl uppercase outline-none">
                    <button onclick="joinGame()" class="w-full bg-[#2f4553] hover:bg-[#3d5565] text-white font-bold py-4 rounded-lg shadow-lg uppercase tracking-wide btn-action">Join Room</button>
                </div>
                <p id="lobbyStatus" class="text-center text-xs text-red-400 mt-4 h-4"></p>
            </div>
        </div>

        <!-- Waiting -->
        <div id="waitingRoom" class="absolute inset-0 z-40 bg-[#0f212e]/95 backdrop-blur hidden flex flex-col items-center justify-center">
            <div class="bg-[#1a2c38] p-8 rounded-2xl border border-[#2f4553] shadow-2xl w-full max-w-lg text-center">
                <p class="text-gray-500 text-xs font-bold uppercase mb-2">Share Code</p>
                <p id="waitingRoomCode" class="text-5xl font-mono font-black text-[#00e701] tracking-widest mb-8 select-all cursor-pointer">---</p>
                <div class="text-left mb-6 bg-[#0f212e] p-4 rounded-xl border border-[#2f4553]">
                    <p class="text-gray-500 text-xs font-bold uppercase mb-3">Players</p>
                    <ul id="playerList" class="space-y-2"></ul>
                </div>
                <button id="btnStartGame" onclick="hostStartGame()" class="hidden w-full bg-[#00e701] text-black font-bold py-3 rounded-lg uppercase tracking-wide btn-action">Deal Cards</button>
                <p id="msgWaiting" class="text-gray-500 text-sm animate-pulse">Waiting for host...</p>
            </div>
        </div>

        <!-- Game Table -->
        <div id="opponentsArea" class="w-full flex justify-center gap-2 md:gap-6 flex-wrap mt-2 min-h-[140px] z-10"></div>

        <div class="flex flex-col items-center justify-center gap-6 my-2 z-10 w-full">
            <div class="flex flex-col items-center gap-2">
                <div class="bg-[#0f212e]/90 px-8 py-2 rounded-full border border-[#2f4553] flex items-center gap-2 shadow-2xl">
                    <span class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Total Pot</span>
                    <span id="potDisplay" class="text-white font-mono font-bold text-2xl">$0</span>
                </div>
                <div id="gamePhaseDisplay" class="text-[#00e701] text-xs font-bold font-mono uppercase tracking-[0.2em] opacity-80">PRE-FLOP</div>
            </div>

            <div id="communityArea" class="flex justify-center gap-2 md:gap-3 h-[90px] md:h-[126px]"></div>
            <div id="handResult" class="h-8 text-2xl font-black italic text-white text-center drop-shadow-lg opacity-0 transition-opacity"></div>
        </div>

        <div class="w-full flex flex-col items-center z-10 mb-2">
            <div class="mb-3 flex flex-col items-center gap-1">
                <div class="flex items-center gap-2 bg-[#1a2c38] px-3 py-1 rounded-full border border-[#2f4553]">
                    <span class="text-gray-400 text-[10px] font-bold uppercase">Your Hand</span>
                    <span id="playerHandName" class="text-[#00e701] font-bold text-xs uppercase">High Card</span>
                </div>
            </div>
            <div id="playerHand" class="flex justify-center gap-2 mb-6 h-[90px] md:h-[126px]"></div>
        </div>

    </main>

    <!-- Controls -->
    <footer class="bg-[#1a2c38] border-t border-[#2f4553] p-4 z-20 shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.3)]">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-4 items-center justify-between">
            <div id="turnControls" class="flex flex-col gap-2 w-full md:w-auto opacity-50 pointer-events-none transition-opacity duration-200">
                <div class="flex items-center justify-between text-[10px] text-gray-400 font-bold uppercase px-1">
                    <span>Raise Amount</span>
                    <span id="raiseAmountDisplay" class="text-white font-mono text-sm">$0</span>
                </div>
                <div class="bg-[#0f212e] p-2 rounded-lg flex items-center w-full md:w-72 border border-[#2f4553]">
                    <input type="range" id="raiseSlider" min="0" max="1000" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#00e701]">
                </div>
            </div>

            <div id="actionButtons" class="w-full md:w-auto flex gap-3 opacity-50 pointer-events-none transition-opacity duration-200">
                <button onclick="sendAction('fold')" class="flex-1 bg-[#2f4553] hover:bg-[#3d5565] text-white font-bold py-4 px-8 rounded-lg border-b-4 border-[#1a2c38] active:border-b-0 active:translate-y-1 text-sm uppercase btn-action">Fold</button>
                <button onclick="sendAction('check')" id="btnCheckCall" class="flex-1 bg-[#2f4553] hover:bg-[#3d5565] text-white font-bold py-4 px-8 rounded-lg border-b-4 border-[#1a2c38] active:border-b-0 active:translate-y-1 text-sm uppercase btn-action">Check</button>
                <button onclick="sendAction('raise')" id="btnRaise" class="flex-1 bg-[#00e701] hover:bg-[#00c201] text-black font-bold py-4 px-8 rounded-lg border-b-4 border-[#00b001] active:border-b-0 active:translate-y-1 text-sm uppercase btn-action">Raise</button>
            </div>
        </div>
    </footer>

    <script>
        // === UPDATE THIS URL ===
        const socket = io('https://mppokerfiles.onrender.com'); 

        let myUserId = null;
        let myRoomCode = null;
        let gameState = null;
        const dom = {}; 

        // Map IDs to dom object
        ['lobbyScreen','waitingRoom','viewCreate','viewJoin','playerNameInput','startStackInput','roomCodeInput','lobbyStatus','roomCodeDisplay','waitingRoomCode','playerList','btnStartGame','msgWaiting','opponentsArea','playerHand','communityArea','potDisplay','balanceDisplay','gamePhaseDisplay','turnControls','actionButtons','btnCheckCall','raiseSlider','raiseAmountDisplay','handResult','playerHandName'].forEach(id => dom[id] = document.getElementById(id));

        socket.on('connect', () => myUserId = socket.id);
        socket.on('roomCreated', ({ roomCode, userId }) => { myRoomCode = roomCode; myUserId = userId; showWaitingRoom(roomCode, true); });
        socket.on('joinedRoom', ({ roomCode, userId }) => { myRoomCode = roomCode; myUserId = userId; showWaitingRoom(roomCode, false); });
        socket.on('gameState', (state) => { gameState = state; renderGame(); });
        socket.on('error', (msg) => { dom.lobbyStatus.innerText = msg; setTimeout(() => dom.lobbyStatus.innerText="", 3000); });

        function showWaitingRoom(code, isHost) {
            dom.lobbyScreen.classList.add('hidden');
            dom.waitingRoom.classList.remove('hidden');
            dom.btnStartGame.style.display = isHost ? 'block' : 'none';
            dom.msgWaiting.style.display = isHost ? 'none' : 'block';
            dom.roomCodeDisplay.innerText = code;
            dom.waitingRoomCode.innerText = code;
        }

        window.switchTab = (t) => {
            dom.viewCreate.style.display = t==='create'?'block':'none';
            dom.viewJoin.style.display = t==='join'?'block':'none';
            document.getElementById('tabCreate').className = t==='create'?"pb-2 text-[#00e701] border-b-2 border-[#00e701] font-bold":"pb-2 text-gray-500 hover:text-white";
            document.getElementById('tabJoin').className = t==='join'?"pb-2 text-[#00e701] border-b-2 border-[#00e701] font-bold":"pb-2 text-gray-500 hover:text-white";
        };

        window.createGame = () => socket.emit('createRoom', { name: dom.playerNameInput.value, startStack: dom.startStackInput.value });
        window.joinGame = () => socket.emit('joinRoom', { name: dom.playerNameInput.value, roomCode: dom.roomCodeInput.value });
        window.hostStartGame = () => socket.emit('startGame', { roomCode: myRoomCode });
        window.sendAction = (action) => socket.emit('action', { roomCode: myRoomCode, action, amount: parseInt(dom.raiseSlider.value) });

        // --- RENDER LOGIC ---
        const SUIT_ICONS = { 'h': '♥', 'd': '♦', 'c': '♣', 's': '♠' };
        const RANK_VALS = { '2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14 };

        function renderGame() {
            if (!gameState) return;
            if (gameState.status === 'waiting') {
                dom.playerList.innerHTML = gameState.players.map(p => 
                    `<li class="bg-[#0f212e] p-3 rounded-lg border border-[#2f4553] flex justify-between items-center"><span class="text-white font-bold">${p.name}</span><span class="text-[#00e701] font-mono font-bold">$${p.chips}</span></li>`
                ).join('');
                return;
            } else dom.waitingRoom.classList.add('hidden');

            const me = gameState.players.find(p => p.id === myUserId);
            const isFinished = gameState.status === 'finished';

            dom.gamePhaseDisplay.innerText = gameState.stage.toUpperCase();
            dom.potDisplay.innerText = `$${gameState.pot}`;
            if(me) dom.balanceDisplay.innerText = `$${me.chips}`;

            // Render Opponents
            dom.opponentsArea.innerHTML = '';
            gameState.players.forEach((p, idx) => {
                if(p.id === myUserId) return;
                const isActive = idx === gameState.turnIndex;
                
                // Show cards if finished/showdown, otherwise backs
                let cardsHtml = '';
                if(p.status !== 'folded' && p.status !== 'busted') {
                    if(isFinished) {
                        cardsHtml = p.hand.map(c => getCardHtml(c, false)).join('');
                    } else {
                        cardsHtml = `<div class="w-8 md:w-10 h-11 md:h-14 bg-[#2f4553] rounded border border-gray-400 card-back"></div><div class="w-8 md:w-10 h-11 md:h-14 bg-[#2f4553] rounded border border-gray-400 card-back ml-1"></div>`;
                    }
                }

                const div = document.createElement('div');
                div.className = `opponent-seat p-2 relative flex flex-col items-center ${isActive ? 'active-turn' : ''} ${p.status==='folded'?'opponent-folded':''}`;
                div.innerHTML = `
                    <div class="absolute -top-3 w-8 h-8 rounded-full bg-[#2f4553] border border-gray-500 flex items-center justify-center text-xs font-bold text-gray-300"><i class="fas fa-user"></i></div>
                    <div class="mt-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider">${p.name}</div>
                    <div class="font-mono text-[#00e701] text-xs font-bold">$${p.chips}</div>
                    <div class="flex mt-1 justify-center">${cardsHtml}</div>
                    ${p.bet>0 ? `<div class="absolute -right-2 top-0 bg-yellow-500 text-black text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-lg">$${p.bet}</div>` : ''}
                `;
                dom.opponentsArea.appendChild(div);
            });

            // Community Cards
            updateCards(dom.communityArea, gameState.communityCards);

            // Player Hand
            if(me) {
                updateCards(dom.playerHand, me.hand);
                
                // Local Hand Evaluation
                if(me.hand.length > 0) {
                    const fullHand = [...me.hand, ...gameState.communityCards];
                    const eval = evaluateLocalHand(fullHand);
                    dom.playerHandName.innerText = eval.name;
                }

                // Controls
                const isMyTurn = (gameState.players.findIndex(p => p.id === myUserId) === gameState.turnIndex);
                if(isMyTurn) {
                    dom.playerHand.classList.add('active-turn');
                    enableControls(me);
                } else {
                    dom.playerHand.classList.remove('active-turn');
                    disableControls();
                }
            }

            // Winner Msg
            if(gameState.winnerMessage) {
                dom.handResult.innerText = gameState.winnerMessage;
                dom.handResult.style.opacity = 1;
            } else {
                dom.handResult.style.opacity = 0;
            }
        }

        // --- HELPERS ---
        function updateCards(container, cards) {
            // Simple render: clear and redraw to ensure proper state
            container.innerHTML = '';
            cards.forEach(c => {
                const el = document.createElement('div');
                el.className = `playing-card animate-pop ${['h','d'].includes(c.suit)?'suit-red':'suit-black'}`;
                el.innerHTML = getCardHtml(c, true);
                container.appendChild(el);
            });
            // Fill slots
            if(container.id === 'communityArea') {
                while(container.children.length < 5) {
                    const s = document.createElement('div'); s.className = 'community-card-slot';
                    container.appendChild(s);
                }
            }
        }

        function getCardHtml(c, fullSize) {
            if(!fullSize) {
                // Mini card for opponents
                const color = ['h','d'].includes(c.suit) ? 'text-red-500' : 'text-gray-900';
                return `<div class="w-8 md:w-10 h-11 md:h-14 bg-white rounded border border-gray-300 flex items-center justify-center font-bold text-xs ${color} ml-1">${c.rank}${SUIT_ICONS[c.suit]}</div>`;
            }
            return `
                <div class="text-left leading-none pointer-events-none">${c.rank}<br><span class="text-xs">${SUIT_ICONS[c.suit]}</span></div>
                <div class="card-center-suit pointer-events-none">${SUIT_ICONS[c.suit]}</div>
                <div class="text-right leading-none rotate-180 pointer-events-none">${c.rank}<br><span class="text-xs">${SUIT_ICONS[c.suit]}</span></div>
            `;
        }

        function enableControls(me) {
            dom.turnControls.classList.remove('opacity-50', 'pointer-events-none');
            dom.actionButtons.classList.remove('opacity-50', 'pointer-events-none');
            const toCall = gameState.currentBet - me.bet;
            
            dom.btnCheckCall.innerText = toCall === 0 ? "CHECK" : `CALL $${toCall}`;
            dom.btnCheckCall.onclick = () => socket.emit('action', { roomCode: myRoomCode, action: toCall===0?'check':'call' });
            
            // Fix bet slider to allow increments of $1
            const maxRaise = me.chips;
            dom.raiseSlider.max = maxRaise;
            dom.raiseSlider.value = Math.min(10, maxRaise); 
            dom.raiseAmountDisplay.innerText = `$${dom.raiseSlider.value}`;
            dom.raiseSlider.oninput = (e) => dom.raiseAmountDisplay.innerText = `$${e.target.value}`;
        }

        function disableControls() {
            dom.turnControls.classList.add('opacity-50', 'pointer-events-none');
            dom.actionButtons.classList.add('opacity-50', 'pointer-events-none');
        }

        // --- CLIENT SIDE EVALUATOR (For visuals) ---
        function evaluateLocalHand(cards) {
            if(cards.length < 2) return { name: "High Card" };
            // Simple frequency checker for display purposes (Full logic is on server)
            const ranks = cards.map(c => c.rank);
            const suits = cards.map(c => c.suit);
            const counts = {}; ranks.forEach(x => counts[x] = (counts[x] || 0) + 1);
            const vals = Object.values(counts);
            
            if(vals.includes(4)) return { name: "Four of a Kind" };
            if(vals.includes(3) && vals.includes(2)) return { name: "Full House" };
            const isFlush = Object.values(suits.reduce((a,c)=>{a[c]=(a[c]||0)+1;return a},{})).some(v=>v>=5);
            if(isFlush) return { name: "Flush" };
            // Straight logic is complex, simplified check:
            if(vals.includes(3)) return { name: "Three of a Kind" };
            if(vals.filter(x=>x===2).length >= 2) return { name: "Two Pair" };
            if(vals.includes(2)) return { name: "Pair" };
            return { name: "High Card" };
        }
    </script>
</body>
</html>
